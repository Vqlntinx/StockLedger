# 소프트웨어 설계서
# Based on IEEE 1016.
1. 소개
    1.1 목적
    본 문서는 StockLedger 프로그램의 소프트웨어 설계를 체계적으로 기술하기 위한 SDD(Software Design Description) 문서이다.
    
    1.2 범위
    StockLedger는 CLI(Command Line Interface) 환경에서 실행되는 소규모 주식 거래 기록 시스템이며 다음 기능을 제공한다.

    주식 거래 추가(BUY/SELL)
    평균단가 기반 포지션 관리
    실현 손익(Realized P/L) 계산
    종목별 손익 조회

    데이터는 메모리 기반 저장소에 보관되며, 파일 또는 DB 연동은 포함하지 않는다.

    1.3 정의 및 약어
    용어	            설명
    Trade	           한 번의 매수 또는 매도 거래
    Position	       특정 종목의 현재 보유 수량 및 평균 단가
    Realized P/L	   매도 시점에서 확정된 손익
    Repository	       데이터 저장/조회 계층
    Service	           비즈니스 로직 처리 계층
    CLI	               Command Line Interface

2. 전체 시스템 개요
    2.1 시스템 관점
    StockLedger는 계층형 아키텍처 로 구성된다.

    +-----------------------------+
    |      프레젠테이션 계층      | ← main.py (CLI)
    +-----------------------------+
    |        서비스 계층          | ← TradeService
    +-----------------------------+
    |      저장소(Repository)     | ← TradeRepository
    +-----------------------------+
    |         도메인 계층         | ← StockTrade, TradeType
    +-----------------------------+

    2.1.1 도메인 계층
    필수 데이터 구조 정의
    StockTrade, TradeType Enum 제공

    2.1.2 저장소 계층
    메모리 기반 데이터 저장/조회
    비즈니스 로직 없음

    2.1.3 서비스 계층
    평균 단가 계산
    포지션 업데이트
    실현 손익 계산
    SELL 거래 유효성 검사
    포지션 필터링(수량 0 제거)

    2.1.4 프레젠테이션 계층
    사용자 입력/출력 처리
    메뉴 기반 흐름 제어
    포맷팅 출력

3. 설계 고려사항
    3.1 가정
    모든 데이터는 메모리에 저장된다.
    평균단가 방식만 지원한다(FIFO/LIFO 없음).
    백데이터(날짜)를 고려하지 않는다.
    수량이 0인 종목은 포지션에서 제거 가능하다.

    3.2 제약 사항
    데이터 영속성 없음
    CLI 환경만 지원
    Python 3.10 이상 필요(Enum, 타입 힌트)

4. 아키텍처 설계
    4.1 구성요소 다이어그램
    ┌────────────────────────┐
    │        main.py         │
    │  - CLI 메뉴 처리        │
    └───────────▲────────────┘
                │ 호출
    ┌───────────┴───────────┐
    │     TradeService       │
    │ + add_trade()          │
    │ + get_positions()      │
    │ + get_realized_pl()    │
    └───────────▲────────────┘
                │ 이용
    ┌───────────┴───────────┐
    │   TradeRepository      │
    │ + save_trade()         │
    │ + get_all_trades()     │
    └───────────▲────────────┘
                │ 포함
    ┌───────────┴───────────┐
    │     StockTrade         │
    │     TradeType          │
    └────────────────────────┘

5. 상세 설계
    5.1 도메인 객체
    TradeType
    class TradeType(Enum):
        BUY = "BUY"
        SELL = "SELL"

    StockTrade 구조
    필드	                    타입	         설명
    ticker	                   str	          종목 코드
    trade_type	              TradeType	      BUY 또는 SELL
    quantity	              int	          거래 수량
    price	                  float	          단가
    fee	                      float	          수수료

    5.2 저장소 계층 (Repository)
    책임:
    거래 데이터 저장
    거래 목록 반환
    비즈니스 로직 없음

    예시:
    class TradeRepository:
        def save_trade(self, trade): ...
        def get_all_trades(self): ...

    5.3 서비스 계층 (Service)
    책임:
    평균단가 계산
    포지션 업데이트
    실현 손익 계산
    SELL 시 수량 유효성 검사
    수량 0인 포지션 제외

    포지션 구조
    positions[ticker] = {
        'qty': int,
        'avg_price': float,
        'total_cost': float
    }

    주요 함수

    add_trade(trade)
    get_positions()
    get_realized_pl()
    get_realized_pl_by_ticker(ticker)

    5.4 프레젠테이션 계층 (Presentation)
    책임:
    사용자 메뉴 인터페이스 제공
    입력 처리 및 검증
    결과 출력

    메뉴 구성
    1. 거래 추가
    2. 포지션 조회
    3. 실현손익 조회
    4. 종목별 실현손익 조회
    5. 종료

6. 알고리즘 설계
   6.1 평균단가 계산 (BUY)
   old_qty = position.qty
   new_qty = old_qty + trade.qty
   new_total_cost = old_total_cost + (trade.price * trade.qty) + fee
   new_avg_price = new_total_cost / new_qty

   6.2 실현손익 계산 (SELL)
   pl = (sell_price - avg_buy_price) * sold_qty - fee
   realized_pl[ticker] += pl

7. 사용자 인터페이스 (User Interface)
    CLI 예시
    === StockLedger Mini ===
    1. Add trade
    2. View positions
    3. View realized P/L
    4. View realized P/L by ticker
    5. Exit


    포지션 조회 예시:

    [005930]
    Quantity: 15
    Average Price: 72000.00
    Total Cost: 1080000.00    